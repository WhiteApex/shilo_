<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Перенаправляем…</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg: #0b1220;
      --card:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8;
      --ring:#1e293b; --good:#10b981; --bad:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --accent:#0284c7; --ring:#e2e8f0;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at -10% -20%, rgba(56,189,248,.25), transparent 60%),
        radial-gradient(800px 600px at 110% 10%, rgba(16,185,129,.2), transparent 60%),
        var(--bg);
      display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(680px,100%);
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:18px; padding:20px 20px 16px;
      box-shadow:0 10px 30px rgba(2,6,23,.25);
      position:relative; overflow:hidden;
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    h1{margin:0 0 6px; font-size:20px; letter-spacing:.2px}
    p{margin:0; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--ring); background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
      font-weight:600; font-size:14px;
    }
    .sep{opacity:.5; margin:0 6px}
    .spinner{
      width:18px; height:18px; border-radius:50%;
      border:2.5px solid transparent; border-top-color:var(--accent); border-left-color:var(--accent);
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{height:6px; background:rgba(56,189,248,.2); border-radius:999px; overflow:hidden; margin:14px 0 10px}
    .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#22d3ee); border-radius:inherit; transition:width .25s ease}
    .footer{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px}
    .btn{
      appearance:none; border:1px solid var(--ring); background:transparent; color:var(--text);
      padding:9px 14px; border-radius:12px; font-weight:600; cursor:pointer;
    }
    .btn.primary{background:var(--accent); color:#001018; border-color:transparent}
    code{background:rgba(148,163,184,.12); padding:2px 6px; border-radius:6px}
    .hint{font-size:13px; color:var(--muted)}
    .mini{font-size:13px}
    .fade{animation:fade .4s ease}
    @keyframes fade{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
    .icons{display:flex; gap:8px; align-items:center}
    .ic{width:18px; height:18px; opacity:.9}
  </style>

  <!-- Яндекс.Метрика -->
  <script>
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0];
    k.async=1;k.src=r;a.parentNode.insertBefore(k,a)})(window, document, "script",
    "https://mc.yandex.ru/metrika/tag.js", "ym");
    ym(YOUR_COUNTER_ID, "init", {clickmap:true, trackLinks:true, accurateTrackBounce:true, defer:true});
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/YOUR_COUNTER_ID" style="position:absolute; left:-9999px;" alt=""></div></noscript>
</head>
<body>
  <div class="card fade" id="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="spinner" aria-hidden="true"></div>
        <h1>Перенаправляем…</h1>
      </div>
      <div class="icons">
        <!-- компактные векторные иконки площадок -->
        <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M9.9 14.2 10 17c0 .6.5 1 1 1 .2 0 .4-.1.6-.2l2.4-1.6 3.7 2.8c.7.5 1.7.4 2.2-.3.1-.2.2-.4.3-.6l3.8-14c.2-.9-.3-1.8-1.3-2H22L2.2 9.3C1.4 9.7 1 10.7 1.4 11.5c.2.4.6.7 1 .8l5.3 1.4 10.9-6.9-8.7 7.4Z"/></svg>
        <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm5 4a5 5 0 1 0 0 10 5 5 0 0 0 0-10Z"/></svg>
        <svg class="ic" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 4h18v16H3zM5 7h14v2H5zm0 4h9v2H5zm0 4h7v2H5z"/></svg>
      </div>
    </div>

    <p id="desc" class="mini" style="margin-top:8px">Готовим редирект…</p>

    <div class="bar" aria-hidden="true"><i id="bar"></i></div>

    <div class="row">
      <span class="pill" id="fromPill">откуда: —</span>
      <span class="sep">→</span>
      <span class="pill" id="toPill">куда: —</span>
      <span class="pill" id="plcPill" title="Размещение">placement: —</span>
    </div>

    <div class="footer">
      <span class="hint" id="hint">Если не перенаправило автоматически — нажмите кнопку.</span>
      <a id="manual" class="btn primary" href="#" rel="nofollow noopener">Открыть вручную</a>
    </div>
  </div>

  <script>
  (async function () {
    // прогресс-бар (чисто визуально)
    const bar = document.getElementById('bar');
    let p = 0; const t = setInterval(()=>{ p = Math.min(100, p + 12); bar.style.width = p + '%'; if (p>=100) clearInterval(t); }, 80);

    function go(destUrl){
      const MAX_WAIT = 350; // мс — комфортно и почти незаметно
      let redirected = false;
      const doRedirect = () => {
        if (redirected) return; redirected = true;
        try{
          const loc = new URL(location.href), d = new URL(destUrl);
          const loop = (d.host===loc.host) && d.pathname.split('/').includes('r');
          if (!loop) location.replace(d.toString());
        } catch { location.href = destUrl; }
      };
      setTimeout(doRedirect, MAX_WAIT);
      return doRedirect; // колбэк для ym()
    }

    function setText(id, text){ const el=document.getElementById(id); if(el) el.textContent=text; }

    try{
      const loc = new URL(window.location.href);
      const parts = loc.pathname.replace(/^\/+|\/+$/g,"").split("/");
      const rIdx = parts.indexOf("r");

      // Поддерживаем оба формата: /r/<from>/<placement>/<to> И /r/?from=&placement=&to=
      const qp = loc.searchParams;
      const from = (rIdx>=0 && parts[rIdx+1]) ? decodeURIComponent(parts[rIdx+1]) : (qp.get("from") || "");
      const placement = (rIdx>=0 && parts[rIdx+2]) ? decodeURIComponent(parts[rIdx+2]) : (qp.get("placement") || "");
      const to = (rIdx>=0 && parts[rIdx+3]) ? decodeURIComponent(parts[rIdx+3]) : (qp.get("to") || "");
      if(!from || !placement || !to) throw new Error("Неверный путь. Ожидается /r/<from>/<placement>/<to> или /r/?from=&placement=&to=");

      const basePrefix = rIdx > 0 ? "/" + parts.slice(0, rIdx).join("/") : "";
      const routesUrl = basePrefix + "/r/routes.json?v=2";
      const resp = await fetch(routesUrl, { cache: "no-store" });
      if (!resp.ok) throw new Error("Не найден routes.json");
      const cfg = await resp.json();

      const fromPlat = cfg.platforms?.[from];
      const toPlat   = cfg.platforms?.[to];
      const plc      = cfg.placements?.[placement];
      if(!fromPlat) throw new Error("Unknown from: "+from);
      if(!toPlat)   throw new Error("Unknown to: "+to);
      if(!plc)      throw new Error("Unknown placement: "+placement);

      // Визуал заполняем
      setText('fromPill', `откуда: ${cfg.labels?.[from] || fromPlat.name || from}`);
      setText('toPill',   `куда: ${cfg.labels?.[to]   || toPlat.name   || to}`);
      setText('plcPill',  `placement: ${plc.utm_medium || placement}`);
      setText('desc', `Ведём из «${cfg.labels?.[from] || from}» → «${cfg.labels?.[to] || to}».`);

      // Целевой URL (to_url переопределяет dest)
      const toOverride = qp.get("to_url");
      const dest = new URL(toOverride || toPlat.dest);

      // UTM
      const utm_source   = qp.get("utm_source")   || (cfg.labels?.[from] || fromPlat.name || from);
      const utm_medium   = qp.get("utm_medium")   || (plc.utm_medium || placement);
      const utm_campaign = qp.get("utm_campaign") || (cfg.defaults?.utm_campaign || "");
      const utm_content  = qp.get("utm_content")  || "";
      const utm_term     = qp.get("utm_term")     || "";

      if (utm_source)   dest.searchParams.set("utm_source", utm_source);
      if (utm_medium)   dest.searchParams.set("utm_medium", utm_medium);
      if (utm_campaign) dest.searchParams.set("utm_campaign", utm_campaign);
      if (utm_content)  dest.searchParams.set("utm_content", utm_content);
      if (utm_term)     dest.searchParams.set("utm_term", utm_term);

      // Кнопка «Открыть вручную»
      const manual = document.getElementById('manual');
      manual.href = dest.toString();

      // Метрика + редирект
      const params = {
        slug_mode:"matrix",
        from_platform: from, to_platform: to, placement,
        destination: dest.toString(),
        utm_source, utm_medium, utm_campaign, utm_content, utm_term,
        ts: Date.now()
      };
      const redirectNow = go(dest.toString());
      if (typeof ym === "function") {
        ym(YOUR_COUNTER_ID, 'reachGoal', 'redirect_click', params, redirectNow);
        // ym(YOUR_COUNTER_ID, 'params', params); // если нужны ещё и «параметры визита»
      }
    } catch (e){
      console.error(e);
      setText('desc', 'Ошибка редиректа: ' + (e && e.message ? e.message : e));
      document.getElementById('manual').classList.remove('primary');
      document.getElementById('manual').textContent = 'Обновить страницу';
      document.getElementById('manual').href = location.href;
    }
  })();
  </script>
</body>
</html>
