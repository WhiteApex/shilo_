<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redirecting…</title>
  <style>
    body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .box { max-width: 640px; margin: 0 auto; padding: 16px; border: 1px solid #eee; border-radius: 12px; }
    .muted { color: #666; }
  </style>

  <!-- Яндекс.Метрика -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      k=e.createElement(t),a=e.getElementsByTagName(t)[0];
      k.async=1;k.src=r;a.parentNode.insertBefore(k,a)
    })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    // ⬇️ ВСТАВЬТЕ СВОЙ ID СЧЁТЧИКА
    ym(YOUR_COUNTER_ID, "init", {
      clickmap:true,
      trackLinks:true,
      accurateTrackBounce:true,
      defer:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/YOUR_COUNTER_ID" style="position:absolute; left:-9999px;" alt=""></div></noscript>
</head>
<body>
  <div class="box">
    <strong>Redirecting…</strong>
    <div class="muted">Если это окно видно дольше секунды — обновите страницу.</div>
  </div>

  <script>
    (async function () {
      function go(destUrl) {
        const MAX_WAIT = 300; // мс
        let redirected = false;
        const safe = () => {
          if (redirected) return;
          redirected = true;
          try {
            const loc = new URL(window.location.href);
            const dest = new URL(destUrl);
            const sameHost = dest.host === loc.host;
            const looksLikeLoop = sameHost && dest.pathname.split("/").includes("r");
            if (!looksLikeLoop) window.location.replace(dest.toString());
          } catch (_) {
            window.location.href = destUrl;
          }
        };
        setTimeout(safe, MAX_WAIT); // фолбэк
        return safe; // вернём для колбэка ym()
      }

      try {
        const loc = new URL(window.location.href);
        const parts = loc.pathname.replace(/^\/+|\/+$/g, "").split("/");
        const rIdx = parts.indexOf("r");

        // ожидаем путь /r/<from>/<placement>/<to> (с поддержкой project pages)
        const from = (rIdx >= 0 && parts[rIdx+1]) ? decodeURIComponent(parts[rIdx+1]) : null;
        const placement = (rIdx >= 0 && parts[rIdx+2]) ? decodeURIComponent(parts[rIdx+2]) : null;
        const to = (rIdx >= 0 && parts[rIdx+3]) ? decodeURIComponent(parts[rIdx+3]) : null;
        if (!from || !placement || !to) throw new Error("Bad slug: use /r/<from>/<placement>/<to>");

        // Базовый префикс (для project pages)
        const basePrefix = rIdx > 0 ? "/" + parts.slice(0, rIdx).join("/") : "";
        const routesUrl = basePrefix + "/r/routes.json?v=1";
        const resp = await fetch(routesUrl, { cache: "no-store" });
        if (!resp.ok) throw new Error("routes.json not found");
        const cfg = await resp.json();

        // проверяем площадки и плейсмент
        const fromPlat = cfg.platforms[from];
        const toPlat = cfg.platforms[to];
        const plc = cfg.placements[placement];
        if (!fromPlat) throw new Error("Unknown from platform: " + from);
        if (!toPlat) throw new Error("Unknown to platform: " + to);
        if (!plc) throw new Error("Unknown placement: " + placement);

        // Итоговый URL назначения
        // 1) если в короткой ссылке передан ?to_url=... — используем его
        // 2) иначе берём дефолтный dest из platforms[to].dest
        const qp = loc.searchParams;
        const toUrlOverride = qp.get("to_url");
        const dest = new URL(toUrlOverride || toPlat.dest);

        // UTM: из query переопределяют дефолты
        const utm_source   = qp.get("utm_source")   || (cfg.labels?.[from] || fromPlat.name || from);
        const utm_medium   = qp.get("utm_medium")   || (plc.utm_medium || placement);
        const utm_campaign = qp.get("utm_campaign") || (cfg.defaults?.utm_campaign || "");
        const utm_content  = qp.get("utm_content")  || "";
        const utm_term     = qp.get("utm_term")     || "";

        // Добавляем UTM к целевому URL (нужны, если ведёте на ваш сайт/лендинг)
        if (utm_source)   dest.searchParams.set("utm_source", utm_source);
        if (utm_medium)   dest.searchParams.set("utm_medium", utm_medium);
        if (utm_campaign) dest.searchParams.set("utm_campaign", utm_campaign);
        if (utm_content)  dest.searchParams.set("utm_content", utm_content);
        if (utm_term)     dest.searchParams.set("utm_term", utm_term);

        // Параметры события Метрики
        const params = {
          slug_mode: "matrix",
          from_platform: from,
          to_platform: to,
          placement: placement,
          destination: dest.toString(),
          utm_source, utm_medium, utm_campaign, utm_content, utm_term,
          ts: Date.now()
        };

        const redirectNow = go(dest.toString());

        // Яндекс.Метрика: цель + параметры
        if (typeof ym === "function") {
          ym(YOUR_COUNTER_ID, 'reachGoal', 'redirect_click', params, redirectNow);
          // опционально: отдельные параметры визита
          // ym(YOUR_COUNTER_ID, 'params', params);
        }
      } catch (e) {
        console.error(e);
        const el = document.querySelector(".muted");
        if (el) el.textContent = "Ошибка редиректа: " + (e && e.message ? e.message : e);
      }
    })();
  </script>
</body>
</html>
