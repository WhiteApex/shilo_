<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Перенаправляем…</title>
  <meta name="theme-color" content="#0ea5e9" />

  <!-- ID Яндекс.Метрики -->
  <script>
    // Ваш счётчик Метрики
    const COUNTER_ID = 104829935; // ← ваш ID
  </script>

  <style>
    :root{
      --bg: #0b1220;
      --card:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8;
      --ring:#1e293b; --good:#10b981;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --accent:#0284c7; --ring:#e2e8f0; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at -10% -20%, rgba(56,189,248,.25), transparent 60%),
        radial-gradient(800px 600px at 110% 10%, rgba(16,185,129,.2), transparent 60%),
        var(--bg);
      display:grid; place-items:center; padding:24px;
    }
    .card{
      width:min(680px,100%);
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:18px; padding:20px 20px 16px;
      box-shadow:0 10px 30px rgba(2,6,23,.25);
      position:relative; overflow:hidden;
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    h1{margin:0 0 6px; font-size:20px; letter-spacing:.2px}
    p{margin:0; color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);font-weight:600;font-size:14px}
    .sep{opacity:.5; margin:0 6px}
    .spinner{width:18px;height:18px;border-radius:50%;border:2.5px solid transparent;border-top-color:var(--accent);border-left-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .bar{height:6px;background:rgba(56,189,248,.2);border-radius:999px;overflow:hidden;margin:14px 0 10px}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#22d3ee);border-radius:inherit;transition:width .25s ease}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px}
    .btn{appearance:none;border:1px solid var(--ring);background:transparent;color:var(--text);padding:9px 14px;border-radius:12px;font-weight:600;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--accent);color:#001018;border-color:transparent}
    .mini{font-size:13px}
    .fade{animation:fade .4s ease}
    @keyframes fade{from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none}}
  </style>

  <!-- Яндекс.Метрика (без падений, если ID не задан) -->
  <script>
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      k=e.createElement(t),a=e.getElementsByTagName(t)[0];
      k.async=1;k.src=r;a.parentNode.insertBefore(k,a)
    })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    if (typeof COUNTER_ID === 'number' && COUNTER_ID > 0) {
      ym(COUNTER_ID, "init", { clickmap:true, trackLinks:true, accurateTrackBounce:true, defer:true });
    }
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/104829935" style="position:absolute; left:-9999px;" alt="">
    </div>
  </noscript>
</head>
<body>
  <div class="card fade" id="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="spinner" aria-hidden="true"></div>
        <h1>Перенаправляем…</h1>
      </div>
    </div>

    <p id="desc" class="mini" style="margin-top:8px">Переходим…</p>
    <div class="bar" aria-hidden="true"><i id="bar"></i></div>

    <div class="row">
      <span class="pill" id="fromPill">откуда: —</span>
      <span class="sep">→</span>
      <span class="pill" id="toPill">куда: —</span>
      <span class="pill" id="plcPill" title="Размещение">placement: —</span>
    </div>

    <div class="footer">
      <span class="mini" id="hint">Если не перенаправило автоматически — нажмите кнопку.</span>
      <a id="manual" class="btn primary" href="#" rel="nofollow noopener">Открыть вручную</a>
    </div>
  </div>

  <script>
  (async function () {
    // визуальный прогресс
    const bar = document.getElementById('bar');
    let p = 0; const t = setInterval(()=>{ p = Math.min(100, p + 12); bar.style.width = p + '%'; if (p>=100) clearInterval(t); }, 80);
    const setText = (id, text) => { const el=document.getElementById(id); if(el) el.textContent=text; };

    function go(destUrl){
      const MAX_WAIT = 350;
      let redirected = false;
      const doRedirect = () => {
        if (redirected) return; redirected = true;
        try{
          const loc = new URL(location.href), d = new URL(destUrl);
          const loop = (d.host===loc.host) && d.pathname.split('/').includes('r');
          if (!loop) location.replace(d.toString());
        } catch { location.href = destUrl; }
      };
      setTimeout(doRedirect, MAX_WAIT);
      return doRedirect; // колбэк для ym()
    }

    try{
      const loc = new URL(window.location.href);
      const parts = loc.pathname.replace(/^\/+|\/+$/g,"").split("/");
      const rIdx = parts.indexOf("r");
      const qp = loc.searchParams;

      // Поддержка обоих форматов: /r/<from>/<placement>/<to> И /r/?from=&placement=&to=
      const from = (rIdx>=0 && parts[rIdx+1]) ? decodeURIComponent(parts[rIdx+1]) : (qp.get("from") || "");
      const placement = (rIdx>=0 && parts[rIdx+2]) ? decodeURIComponent(parts[rIdx+2]) : (qp.get("placement") || "");
      const to = (rIdx>=0 && parts[rIdx+3]) ? decodeURIComponent(parts[rIdx+3]) : (qp.get("to") || "");
      if(!from || !placement || !to) throw new Error("Неверный путь. Ожидается /r/<from>/<placement>/<to> или /r/?from=&placement=&to=");

      // Базовый префикс для project pages
      const basePrefix = rIdx > 0 ? "/" + parts.slice(0, rIdx).join("/") : "";
      const routesUrl = basePrefix + "/r/routes.json?v=2";
      const resp = await fetch(routesUrl, { cache: "no-store" });
      if (!resp.ok) throw new Error("Не найден routes.json");
      const cfg = await resp.json();

      const fromPlat = cfg.platforms?.[from];
      const toPlat   = cfg.platforms?.[to];
      const plc      = cfg.placements?.[placement];
      if(!fromPlat) throw new Error("Unknown from: "+from);
      if(!toPlat)   throw new Error("Unknown to: "+to);
      if(!plc)      throw new Error("Unknown placement: "+placement);

      // Визуал
      setText('fromPill', `откуда: ${cfg.labels?.[from] || fromPlat.name || from}`);
      setText('toPill',   `куда: ${cfg.labels?.[to]   || toPlat.name   || to}`);
      setText('plcPill',  `placement: ${plc.utm_medium || placement}`);
      setText('desc', `Ведём из «${cfg.labels?.[from] || from}» → «${cfg.labels?.[to] || to}».`);

      // Итоговый URL (to_url переопределяет dest)
      const toOverride = qp.get("to_url");
      const dest = new URL(toOverride || toPlat.dest);

      // UTM
      const utm_source   = qp.get("utm_source")   || (cfg.labels?.[from] || fromPlat.name || from);
      const utm_medium   = qp.get("utm_medium")   || (plc.utm_medium || placement);
      const utm_campaign = qp.get("utm_campaign") || (cfg.defaults?.utm_campaign || "");
      const utm_content  = qp.get("utm_content")  || "";
      const utm_term     = qp.get("utm_term")     || "";

      if (utm_source)   dest.searchParams.set("utm_source", utm_source);
      if (utm_medium)   dest.searchParams.set("utm_medium", utm_medium);
      if (utm_campaign) dest.searchParams.set("utm_campaign", utm_campaign);
      if (utm_content)  dest.searchParams.set("utm_content", utm_content);
      if (utm_term)     dest.searchParams.set("utm_term", utm_term);

      // Кнопка «Открыть вручную»
      const manual = document.getElementById('manual');
      manual.href = dest.toString();

      // Редирект + Метрика
      const params = {
        slug_mode:"matrix",
        from_platform: from, to_platform: to, placement,
        destination: dest.toString(),
        utm_source, utm_medium, utm_campaign, utm_content, utm_term,
        ts: Date.now()
      };

      const isDebug = (qp.get('debug') === '1');
      if (isDebug) {
        setText('hint', 'DEBUG: редирект отключён. Проверьте параметры и ссылку ниже.');
        manual.textContent = 'Открыть целевой URL';
        return; // без редиректа
      }

      const redirectNow = go(dest.toString());
      if (typeof ym === "function" && typeof COUNTER_ID === 'number' && COUNTER_ID > 0) {
        ym(COUNTER_ID, 'reachGoal', 'redirect_click', params, redirectNow);
        // при желании: ym(COUNTER_ID, 'params', params);
      }
    } catch (e){
      console.error(e); // только в консоль, пользователю — мягкий текст
      setText('desc', 'Переходим… Если не открылось — нажмите кнопку ниже.');
      const manual = document.getElementById('manual');
      manual.classList.add('primary');
      manual.textContent = 'Открыть вручную';
      manual.href = location.href;
    }
  })();
  </script>
</body>
</html>
